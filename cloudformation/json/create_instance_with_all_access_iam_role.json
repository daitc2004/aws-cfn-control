{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Launch an instance with Instance Store, create a RAID0 with local drives, setup an NFS server and export the nfs share",
  "Resources": {
    "MyInstance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "InstanceType"     : { "Ref" : "MyInstanceType" },
        "SubnetId"         : { "Ref" : "MySubnet" },
        "ImageId"          : { "Fn::FindInMap" :  [ "AWSRegionAMI", { "Ref" : "AWS::Region" } , "HVM64" ] },
        "KeyName"          :         { "Ref": "MyKeyName"  },
        "SecurityGroupIds" : [ { "Ref": "MySecurityGroups" } ],
        "IamInstanceProfile": { "Ref": "NFSInstanceProfile" },
        "UserData"         : { "Fn::Base64" : { "Fn::Join" : ["", [
          "#!/bin/bash -xe\n",
          "echo hello > /tmp/file.txt", "\n"

          ]]}}
      }
    },
    "RootRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version" : "2012-10-17",
          "Statement": [ {
            "Effect": "Allow",
            "Principal": {
              "Service": [ "ec2.amazonaws.com" ]
            },
            "Action": [ "sts:AssumeRole" ]
          } ]
        },
        "Path": "/"
      }
    },
    "RolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "root",
        "PolicyDocument": {
          "Version" : "2012-10-17",
          "Statement": [ {
            "Effect": "Allow",
            "Action": "*",
            "Resource": "*"
          } ]
        },
        "Roles": [ { "Ref": "RootRole" } ]
      }
    },
    "NFSInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [ { "Ref": "RootRole" } ]
      }
    }
  },
  "Parameters": {
    "MyInstanceType": {
      "Description": "My instance type",
      "Type": "String",
      "Default": "m4.10xlarge",
      "AllowedValues": [
        "m4.10xlarge",
        "i3.8xlarge",
        "i3.16xlarge"
      ],
      "ConstraintDescription": "must be an EC2 instance type with instance store"
    },
    "MyKeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "must be the name of an existing EC2 KeyPair."
    },
    "SSHLocation": {
      "Description": " The IP address range that can be used access the web server using SSH.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "0.0.0.0/0",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    "MySubnet": {
      "Description": "Subnet IDs",
      "Type":  "AWS::EC2::Subnet::Id"
    },
    "MySecurityGroups": {
      "Description": "Security Groups IDs",
      "Type":  "AWS::EC2::SecurityGroup::Id"
    }
  },
  "Mappings" : {
    "AWSRegionAMI": {
      "us-east-1": {
        "HVM64": "ami-0b33d91d"
      }
    }
  },
  "Outputs" : {
    "InstanceID" : {
      "Description": "The Instance ID",
      "Value" : { "Ref" : "MyInstance" }
    }
  }
}

