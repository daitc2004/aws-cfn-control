{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Launch an instance.",
  "Metadata" : {
    "AWS::CloudFormation::Interface" : {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Instance Parameters"
          },
          "Parameters": [
            "MyInstanceType",
            "MyKeyName",
            "VPCId",
            "MySubnet",
            "MySecurityGroups",
            "UsePublicIp"
          ]
        }
      ]
    }
  },
  "Resources": {
    "MyInstance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "InstanceType"     : { "Ref" : "MyInstanceType" },
        "SubnetId"         : { "Ref" : "MySubnet" },
        "ImageId"          : { "Fn::FindInMap" :  [ "AWSRegionAMI", { "Ref" : "AWS::Region" } , "HVM64" ] },
        "KeyName"          :         { "Ref": "MyKeyName"  },
        "SecurityGroupIds" : [ { "Ref": "MySecurityGroups" } ],
        "UserData"         : { "Fn::Base64" : { "Fn::Join" : ["", [
          "#!/bin/bash -xe\n",
          "echo hello > /tmp/file.txt", "\n"
          ]]}}
      }
    }
  },
  "Parameters": {
    "MyInstanceType": {
      "Description": "My instance type",
      "Type": "String",
      "Default": "t2.micro",
      "AllowedValues": [
        "c1.medium",
        "c1.xlarge",
        "c3.2xlarge",
        "c3.4xlarge",
        "c3.8xlarge",
        "c3.large",
        "c3.xlarge",
        "c4.2xlarge",
        "c4.4xlarge",
        "c4.8xlarge",
        "c4.large",
        "c4.xlarge",
        "cc1.4xlarge",
        "cc2.8xlarge",
        "cg1.4xlarge",
        "cr1.8xlarge",
        "d2.2xlarge",
        "d2.4xlarge",
        "d2.8xlarge",
        "d2.xlarge",
        "f1.16xlarge",
        "f1.2xlarge",
        "g2.2xlarge",
        "g2.8xlarge",
        "hi1.4xlarge",
        "hs1.8xlarge",
        "i2.2xlarge",
        "i2.4xlarge",
        "i2.8xlarge",
        "i2.xlarge",
        "i3.16xlarge",
        "i3.2xlarge",
        "i3.4xlarge",
        "i3.8xlarge",
        "i3.large",
        "i3.xlarge",
        "m1.large",
        "m1.medium",
        "m1.small",
        "m1.xlarge",
        "m2.2xlarge",
        "m2.4xlarge",
        "m2.xlarge",
        "m3.2xlarge",
        "m3.large",
        "m3.medium",
        "m3.xlarge",
        "m4.10xlarge",
        "m4.16xlarge",
        "m4.2xlarge",
        "m4.4xlarge",
        "m4.large",
        "m4.xlarge",
        "p2.16xlarge",
        "p2.8xlarge",
        "p2.xlarge",
        "r3.2xlarge",
        "r3.4xlarge",
        "r3.8xlarge",
        "r3.large",
        "r3.xlarge",
        "r4.16xlarge",
        "r4.2xlarge",
        "r4.4xlarge",
        "r4.8xlarge",
        "r4.large",
        "r4.xlarge",
        "t1.micro",
        "t2.2xlarge",
        "t2.large",
        "t2.medium",
        "t2.micro",
        "t2.nano",
        "t2.small",
        "t2.xlarge",
        "x1.16xlarge",
        "x1.32xlarge"
      ],
      "ConstraintDescription": "Must be a valid instance type for that region, with HVM64 support"
    },
    "MyKeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "must be the name of an existing EC2 KeyPair."
    },
    "VPCId": {
      "Type": "AWS::EC2::VPC::Id",
      "Description": "VPC Id for this instance"
    },
    "MySubnet": {
      "Description": "Subnet IDs",
      "Type":  "AWS::EC2::Subnet::Id"
    },
    "MySecurityGroups": {
      "Description": "Security Groups IDs",
      "Type":  "AWS::EC2::SecurityGroup::Id"
    },
    "UsePublicIp" : {
      "Description" : "Should a public IP address be given to the instance",
      "Type" : "String",
      "Default" : "true",
      "ConstraintDescription" : "true/false",
      "AllowedValues" : [
        "true",
        "false"
      ]
    }
  },
  "Mappings" : {
    "AWSRegionAMI": {
      "ap-northeast-1": {
        "HVM64": "ami-56d4ad31"
      },
      "ap-northeast-2": {
        "HVM64": "ami-dac312b4"
      },
      "ap-south-1": {
        "HVM64": "ami-f9daac96"
      },
      "ap-southeast-1": {
        "HVM64": "ami-dc9339bf"
      },
      "ap-southeast-2": {
        "HVM64": "ami-1c47407f"
      },
      "ca-central-1": {
        "HVM64": "ami-ebed508f"
      },
      "eu-central-1": {
        "HVM64": "ami-af0fc0c0"
      },
      "eu-west-1": {
        "HVM64": "ami-70edb016"
      },
      "eu-west-2": {
        "HVM64": "ami-f1949e95"
      },
      "sa-east-1": {
        "HVM64": "ami-80086dec"
      },
      "us-east-1": {
        "HVM64": "ami-0b33d91d"
      },
      "us-east-2": {
        "HVM64": "ami-c55673a0"
      },
      "us-west-1": {
        "HVM64": "ami-165a0876"
      },
      "us-west-2": {
        "HVM64": "ami-f173cc91"
      }
    }
  },
  "Conditions" : {
    "use_public_ip" : { "Fn::Equals" : [ { "Ref" : "UsePublicIp" }, "true" ] }
  },
  "Outputs" : {
    "InstanceID" : {
      "Description": "The Instance ID",
      "Value" : { "Ref" : "MyInstance" }
    },
    "InstancePublicIP" : {
      "Value" :  { "Fn::GetAtt" : [ "MyInstance" , "PublicIp" ]},
      "Condition" :  "use_public_ip"
    },
    "InstancePrivateIP" : {
      "Value" :  { "Fn::GetAtt" : [ "MyInstance" , "PrivateIp" ]}
    }
  }
}

